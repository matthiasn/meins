(ns meins.chart-data-test
  (:require [clojure.test :refer [deftest is testing]]
            [meins.electron.renderer.charts.data :as cd]))

(deftest remaining-times-test
  (testing "handles empty maps"
    (is (= {}
           (cd/remaining-times {} {}))))
  (testing "handles nil values"
    (is (= {}
           (cd/remaining-times nil nil))))
  (testing "handles nil for actual times"
    (is (= {1486080814718 18000
            1486206401941 10800}
           (cd/remaining-times nil {1486206401941 10800
                                    1486080814718 18000}))))
  (testing "remaining times calculated properly"
    (is (= {1485898032295 2700
            1486080338498 3169
            1486080814718 18000
            1486080841220 1516
            1486080959114 1200
            1486206401941 10800}
           (cd/remaining-times
             {1486080338498 2231
              1486080841220 1184
              1486157861454 1863
              1486157703892 842
              1486080959114 2400}
             {1486206401941 10800
              1486080814718 18000
              1486080338498 5400
              1486080841220 2700
              1485898032295 2700
              1486080959114 3600
              1486157861454 1800})))))

(def stats
  {"2017-02-01" {:time-by-book {1486080918727 5544 1486157861454 83 1486080841220 3000}}
   "2017-02-02" {:time-by-book {1486080959114 6189 1486157861454 4891 1486080814718 13665}}
   "2017-02-03" {:time-by-book {1486157861454 1090 1486080338498 15349 1486157703892 4517 1486080959114 2670 1486080814718 16453 1486080841220 1200}}
   "2017-02-04" {:time-by-book {1486080841220 6960 1486157861454 7797 1486206401941 12720 1486080996088 2400 1486080918727 157 1486080338498 3777}}
   "2017-02-05" {:time-by-book {1485898032295 5465 1486080959114 1800 1486080338498 21830 1486157861454 7379 1486080841220 1260}}
   "2017-02-06" {:time-by-book {1486080814718 22101 1486157861454 797 1486080918727 9628 1486080338498 2683 1486157703892 180 1486206401941 7931.99}}
   "2017-02-07" {:time-by-book {1486080996088 549 1486080841220 1200 1486080814718 20464 1486157861454 1980 1486080338498 11210 1485898032295 1560 1486080959114 1326}}
   "2017-02-08" {:time-by-book {1486080338498 2231 1486080841220 1184 1486157861454 1863 1486157703892 842 1486080959114 2400}}
   "2017-02-09" {:time-by-book {}}})

(deftest past-7-days-test
  (testing "times are summed properly"
    (is (= {1486157861454 25797
            1486157703892 5539
            1486206401941 20651
            1486080996088 2949
            1486080814718 72683
            1486080338498 57080
            1486080841220 11804
            1485898032295 7025
            1486080918727 9785
            1486080959114 14385}
           (cd/past-7-days :time-by-book stats))))
  (testing "calling with empty map yields nil"
    (is (= nil
           (cd/past-7-days :time-by-book {}))))
  (testing "calling with nil yields nil"
    (is (= nil
           (cd/past-7-days :time-by-book nil)))))

(deftest time-by-entity-stacked-test
  (testing "works with actual data"
    (is (= [[1486206401941 {:v 20652 :x 207047}]
            [1486157861454 {:v 25797 :x 181250}]
            [1486157703892 {:v 5539 :x 175711}]
            [1486080996088 {:v 2949 :x 172762}]
            [1486080959114 {:v 14385 :x 158377}]
            [1486080918727 {:v 9785 :x 148592}]
            [1486080841220 {:v 11804 :x 136788}]
            [1486080814718 {:v 72683 :x 64105}]
            [1486080338498 {:v 57080 :x 7025}]
            [1485898032295 {:v 7025 :x 0}]]
           (cd/time-by-entity-stacked {1486157861454 25797
                                       1486157703892 5539
                                       1486206401941 20652
                                       1486080996088 2949
                                       1486080814718 72683
                                       1486080338498 57080
                                       1486080841220 11804
                                       1485898032295 7025
                                       1486080918727 9785
                                       1486080959114 14385}))))
  (testing "call with empty map gives empty seq"
    (is (= []
           (cd/time-by-entity-stacked {})))))
